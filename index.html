<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="UTF-8">
<title>Porud쬭ine</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<style>
/* ================= BASE ================= */
body{
  margin:0;
  background:#0f0f0f;
  font-family:Arial;
  color:white;
}

/* ================= FORMA ================= */
.card-form{
  position:fixed;
  top:10px;
  left:10px;
  width:260px;
  background:#1e1e1e;
  border-radius:12px;
  padding:10px;
  z-index:10;
}

input,textarea,select,button{
  width:100%;
  padding:6px;
  border-radius:6px;
  border:none;
  margin-top:6px;
  font-size:13px;
}

.row{display:flex;gap:6px}
button.primary{background:#1976d2;color:white;font-weight:bold}

#sortiranje{margin-top:6px}

/* ================= LISTA ================= */
#lista{
  margin-left:290px;
  padding:20px;
  display:grid;
  grid-template-columns:repeat(auto-fill,4cm);
  gap:10mm;
  background:#151515;
  min-height:100vh;
}

/* ================= KARTICA ================= */
.order-card{
  background:#f5efe6;
  color:#222;
  border-radius:14px;
  padding:8px;
  width:4cm;
  height:6cm;
  font-size:12px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  border:1px solid #e1d8c8;
  box-shadow:0 5px 12px rgba(0,0,0,.25);
}

/* STATUS BOJE KARTICE */
.order-card.status-novo{background:#eee}
.order-card.status-radi{background:#d8ebff}
.order-card.status-gotovo{background:#dff3df}

/* ================= SLIKE ================= */
.card-images{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:3px;
}

.card-images img{
  height:32px;
  object-fit:cover;
  border-radius:4px;
  cursor:pointer;
}

/* ================= BADGE ROK ================= */
.badge{
  padding:3px 8px;
  border-radius:10px;
  color:white;
  font-size:11px;
}

.rok-ok{background:#81c784}
.rok-warning{background:#ffb74d}
.rok-danger{background:#e57373}

/* ================= STATUS SELECT ================= */
.status{
  border:none;
  border-radius:6px;
  padding:4px;
  font-weight:bold;
  font-size:11px;
}

/* ================= ACTIONS ================= */
.actions{
  display:flex;
  justify-content:center;
  gap:12px;
}

.actions span{
  cursor:pointer;
  font-size:16px;
}

/* ================= MODALI ================= */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.8);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
}

.modal img{max-height:8cm}

.modal-box{
  background:#222;
  padding:15px;
  border-radius:12px;
  width:260px;
}
</style>
</head>

<body>

<!-- ================= FORMA ================= -->
<div class="card-form">

<input id="proizvod" placeholder="Proizvod">
<textarea id="komentar" placeholder="Komentar"></textarea>

<div class="row">
  <select id="pismo">
    <option>캕irilica</option>
    <option>Latinica</option>
  </select>

  <select id="stil">
    <option>Pisano</option>
    <option>맚ampano</option>
  </select>
</div>

<input id="rok" placeholder="Rok (dd/mm/yyyy)">
<input id="cena" type="number" placeholder="Cena">

<input id="slike" type="file" multiple accept="image/*">

<button class="primary" onclick="dodajPorudzbinu()">Dodaj</button>

<hr>

<select id="sortiranje" onchange="promeniSort(this.value)">
  <option value="unos">Po unosu</option>
  <option value="rok">Po roku</option>
</select>

</div>

<!-- ================= LISTA ================= -->
<div id="lista"></div>

<!-- ================= IMAGE MODAL ================= -->
<div class="modal" id="imgModal" onclick="this.style.display='none'">
  <img id="modalImg">
</div>

<!-- ================= EDIT MODAL ================= -->
<div class="modal" id="editModal">
  <div class="modal-box">
    <h3>Edit porud쬭ine</h3>

    <input id="editProizvod">
    <textarea id="editKomentar"></textarea>
    <input id="editRok">
    <input id="editCena" type="number">

    <select id="editStatus">
      <option>Novo</option>
      <option>U izradi</option>
      <option>Zavr코eno</option>
    </select>

    <input id="editSlike" type="file" multiple>

    <button onclick="sacuvajEdit()">Sa캜uvaj</button>
    <button onclick="editModal.style.display='none'">Otka쬴</button>
  </div>
</div>

<script>
/* ================= GLOBAL ================= */
const slike=document.getElementById("slike");
const editSlike=document.getElementById("editSlike");
const imgModal=document.getElementById("imgModal");
const modalImg=document.getElementById("modalImg");
const editModal=document.getElementById("editModal");

let trenutnoSort="unos";
let editId=null;

/* ================= KALENDAR ================= */
flatpickr("#rok",{dateFormat:"d/m/Y"});
flatpickr("#editRok",{dateFormat:"d/m/Y"});

/* ================= STATUS KLASE ================= */
const statusKlasa=s=>{
  if(s==="U izradi")return"status-radi";
  if(s==="Zavr코eno")return"status-gotovo";
  return"status-novo";
};

/* ================= ADD ================= */
async function dodajPorudzbinu(){
  const fd=new FormData();
  fd.append("proizvod",proizvod.value);
  fd.append("komentar",komentar.value);
  fd.append("pismo",pismo.value);
  fd.append("stil",stil.value);
  fd.append("rok",rok.value);
  fd.append("cena",cena.value);

  [...slike.files].slice(0,4).forEach(f=>fd.append("slike",f));

  await fetch("/porudzbine",{method:"POST",body:fd});
  ucitajPorudzbine();
}

/* ================= SORT ================= */
function promeniSort(v){
  trenutnoSort=v;
  ucitajPorudzbine();
}

/* ================= STATUS CHANGE ================= */
async function promeniStatus(id,status,selectEl){
  const fd=new FormData();
  fd.append("status",status);

  await fetch(`/porudzbine/${id}`,{
    method:"PUT",
    body:fd
  });

  const card=selectEl.closest(".order-card");
  card.classList.remove("status-novo","status-radi","status-gotovo");
  card.classList.add(statusKlasa(status));
}

/* ================= EDIT ================= */
function otvoriEdit(p){
  editId=p.id;
  editProizvod.value=p.proizvod;
  editKomentar.value=p.komentar;
  editRok.value=p.rok;
  editCena.value=p.cena;
  editStatus.value=p.status||"Novo";
  editModal.style.display="flex";
}

async function sacuvajEdit(){
  const fd=new FormData();
  fd.append("proizvod",editProizvod.value);
  fd.append("komentar",editKomentar.value);
  fd.append("rok",editRok.value);
  fd.append("cena",editCena.value);
  fd.append("status",editStatus.value);

  [...editSlike.files].slice(0,4).forEach(f=>fd.append("slike",f));

  await fetch(`/porudzbine/${editId}`,{method:"PUT",body:fd});
  editModal.style.display="none";
  ucitajPorudzbine();
}

/* ================= DELETE ================= */
async function obrisi(id){
  if(!confirm("Obrisati porud쬭inu?"))return;
  await fetch(`/porudzbine/${id}`,{method:"DELETE"});
  ucitajPorudzbine();
}

/* ================= LOAD ================= */
async function ucitajPorudzbine(){
  const res=await fetch("/porudzbine");
  let data=await res.json();

  if(trenutnoSort==="rok"){
    data.sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
  }

  lista.innerHTML="";

  data.forEach(p=>{
    const div=document.createElement("div");
    div.className="order-card "+statusKlasa(p.status||"Novo");

    const imgs=(p.slike||"").split(",").filter(Boolean)
      .map(f=>`<img src="/uploads/${f}" onclick="imgModal.style.display='flex';modalImg.src='/uploads/${f}'">`)
      .join("");

    div.innerHTML=`
      <b>${p.proizvod}</b>
      <div>${p.komentar}</div>

      <div class="card-images">${imgs}</div>

      <div>${p.cena} RSD</div>

      <select class="status"
        onchange="promeniStatus(${p.id},this.value,this)">
        <option ${p.status==="Novo"?"selected":""}>Novo</option>
        <option ${p.status==="U izradi"?"selected":""}>U izradi</option>
        <option ${p.status==="Zavr코eno"?"selected":""}>Zavr코eno</option>
      </select>

      <div class="actions">
        <span onclick='otvoriEdit(${JSON.stringify(p)})'>九勇</span>
        <span onclick="obrisi(${p.id})">游딈</span>
      </div>
    `;

    lista.appendChild(div);
  });
}

/* ================= AUTO REFRESH ================= */
setInterval(ucitajPorudzbine,5000);
ucitajPorudzbine();
</script>

</body>
</html>
