<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem za Porud≈æbine</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        body{ margin:0; background:#0f0f0f; font-family:Arial; color:white; }
        .card-form{ position:fixed; top:10px; left:10px; width:260px; background:#1e1e1e; border-radius:12px; padding:15px; z-index:10; }
        input, textarea, select, button { width:100%; padding:8px; border-radius:6px; border:none; margin-top:8px; font-size:13px; background:#2b2b2b; color:white; }
        button.primary{ background:#1976d2; font-weight:bold; cursor:pointer; }
        #lista { margin-left:300px; padding:20px; display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:20px; }
        .order-card { background:#f5efe6; color:#222; border-radius:14px; padding:12px; display:flex; flex-direction:column; min-height:250px; }
        .status-novo { background:#ffffff !important; }
        .status-radi { background:#d8ebff !important; }
        .status-gotovo { background:#dff3df !important; }
        .card-images { display:grid; grid-template-columns:repeat(2, 1fr); gap:5px; margin-top:10px; }
        .card-images img { width:100%; height:50px; object-fit:cover; border-radius:4px; cursor:pointer; }
        .modal { position:fixed; inset:0; background:rgba(0,0,0,.8); display:none; align-items:center; justify-content:center; z-index:999; }
        .modal-box { background:#1e1e1e; padding:20px; border-radius:12px; width:300px; }
    </style>
</head>
<body>
    <div class="card-form">
        <input id="proizvod" placeholder="Proizvod">
        <textarea id="komentar" placeholder="Komentar"></textarea>
        <input id="rok" placeholder="Rok (dd/mm/yyyy)">
        <input id="cena" type="number" placeholder="Cena">
        <input id="slike" type="file" multiple>
        <button class="primary" onclick="dodajPorudzbinu()">Dodaj</button>
    </div>
    <div id="lista"></div>
    <div class="modal" id="editModal">
        <div class="modal-box">
            <h3>Izmeni</h3>
            <input id="editProizvod">
            <select id="editStatus">
                <option>Novo</option>
                <option>U izradi</option>
                <option>Zavr≈°eno</option>
            </select>
            <button class="primary" onclick="sacuvajEdit()">Saƒçuvaj</button>
            <button onclick="document.getElementById('editModal').style.display='none'">Zatvori</button>
        </div>
    </div>
    <script>
        flatpickr("#rok", { dateFormat: "d/m/Y" });
        let editId = null;

        async function ucitajPorudzbine() {
            const res = await fetch("/porudzbine");
            const data = await res.json();
            const lista = document.getElementById("lista");
            lista.innerHTML = "";
            data.forEach(p => {
                const div = document.createElement("div");
                div.className = `order-card ${p.status === 'U izradi' ? 'status-radi' : p.status === 'Zavr≈°eno' ? 'status-gotovo' : 'status-novo'}`;
                const imgs = (p.slike || "").split(",").filter(Boolean).map(url => `<img src="${url}" onclick="window.open('${url}')">`).join("");
                div.innerHTML = `<b>${p.proizvod}</b><p>${p.komentar || ''}</p><div class="card-images">${imgs}</div><b>${p.cena || 0} RSD</b>
                <select onchange="promeniStatus(${p.id}, this.value)"><option ${p.status==='Novo'?'selected':''}>Novo</option><option ${p.status==='U izradi'?'selected':''}>U izradi</option><option ${p.status==='Zavr≈°eno'?'selected':''}>Zavr≈°eno</option></select>
                <button onclick='otvoriEdit(${JSON.stringify(p)})'>‚úèÔ∏è</button><button onclick="obrisi(${p.id})">üóëÔ∏è</button>`;
                lista.appendChild(div);
            });
        }

        async function dodajPorudzbinu() {
            const fd = new FormData();
            fd.append("proizvod", document.getElementById("proizvod").value);
            fd.append("komentar", document.getElementById("komentar").value);
            fd.append("rok", document.getElementById("rok").value);
            fd.append("cena", document.getElementById("cena").value);
            [...document.getElementById("slike").files].forEach(f => fd.append("slike", f));
            await fetch("/porudzbine", { method: "POST", body: fd });
            ucitajPorudzbine();
        }

        async function promeniStatus(id, status) {
            await fetch(`/porudzbine/${id}`, { method: "PUT", headers: {"Content-Type":"application/json"}, body: JSON.stringify({status}) });
            ucitajPorudzbine();
        }

        async function obrisi(id) {
            if(confirm("Obri≈°i?")) { await fetch(`/porudzbine/${id}`, {method:"DELETE"}); ucitajPorudzbine(); }
        }

        function otvoriEdit(p) {
            editId = p.id;
            document.getElementById("editProizvod").value = p.proizvod;
            document.getElementById("editStatus").value = p.status;
            document.getElementById("editModal").style.display = "flex";
        }

        async function sacuvajEdit() {
            await fetch(`/porudzbine/${editId}`, { 
                method: "PUT", 
                headers: {"Content-Type":"application/json"}, 
                body: JSON.stringify({ proizvod: document.getElementById("editProizvod").value, status: document.getElementById("editStatus").value }) 
            });
            document.getElementById("editModal").style.display = "none";
            ucitajPorudzbine();
        }

        ucitajPorudzbine();
    </script>
</body>
</html>
